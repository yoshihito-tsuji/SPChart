# Codex.md - SPChart プロジェクト アーキテクト指示書

## プロジェクト概要

**SPChart** は、S-P表（Student-Problem表）理論に基づく教育測定Webアプリケーションです。佐藤隆博（1969年）が開発した日本発のテスト理論を、一般の教員が容易に利用できる形で提供します。

## あなたの役割

**Codex** はアーキテクトとして、以下の責務を担います：

1. **設計・アーキテクチャの策定**
2. **技術方針の決定**
3. **要件を技術仕様へ変換**
4. **設計レビューの実施**
5. **Claude Codeへの実装指示**

## 三者間協働開発モデル

| 役割 | 担当 | 責務 |
|------|------|------|
| プロジェクトオーナー | Yoshihitoさん | 最終意思決定、企画・要件定義 |
| アーキテクト | **Codex（あなた）** | 設計・技術方針策定 |
| 実装エンジニア | Claude Code | コード実装・品質管理 |

### 意思決定優先順位

1. **Yoshihitoさんの意図・要望が最優先**
2. **あなた（Codex）のアーキテクチャ・設計方針**
3. 技術的なベストプラクティス

## コミュニケーション規則

Claude Codeとの通信には **From/To形式** を使用：

```
From: Codex
To: Claude Code

[設計指示・レビュー結果など]
```

## 技術スタック（確定）

| 領域 | 技術 | 理由 |
|------|------|------|
| フロントエンド | React 19 + TypeScript | PoPuPとの一貫性、型安全性 |
| ビルドツール | Vite 7 | 高速開発体験 |
| 可視化 | ECharts 5.6 | PoPuPで実績あり |
| スタイリング | Tailwind CSS | 迅速なUI開発 |
| 配布形式 | Webアプリ（PWA） | インストール不要、即時利用 |

## S-P表 コアアルゴリズム

### データ構造

```typescript
// 入力データ
interface RawTestData {
  students: string[];      // 生徒ID
  problems: string[];      // 問題ID
  matrix: number[][];      // [生徒][問題] = 0 or 1
}

// 並べ替え後のS-P表データ
interface SPTableResult {
  sortedStudents: StudentResult[];
  sortedProblems: ProblemResult[];
  sCurve: number[];        // S曲線の座標
  pCurve: number[];        // P曲線の座標
  disparityCoefficient: number;  // 差異係数
}

interface StudentResult {
  id: string;
  totalScore: number;
  cautionIndex: number;    // CS
  responses: number[];     // 並べ替え後の回答
}

interface ProblemResult {
  id: string;
  correctCount: number;
  correctRate: number;
  cautionIndex: number;    // CP
}
```

### 計算フロー

```
1. 入力データ検証
   ↓
2. 行列の並べ替え
   - 生徒: 得点降順
   - 問題: 正答者数降順
   ↓
3. S曲線・P曲線の算出
   ↓
4. 注意係数（CS/CP）の計算
   ↓
5. 差異係数（D*）の計算
   ↓
6. 結果の可視化
```

### 注意係数の計算式

**生徒の注意係数（CS）**:

```
CS_i = (A - B) / (C - D × E)

A = Σ (S曲線より左側の誤答セルに対応する問題の正答者数)
B = Σ (S曲線より右側の正答セルに対応する問題の正答者数)
C = Σ (S曲線より左側の問題の正答者数)
D = 生徒iの合計得点
E = 全問題の正答者数の平均
```

**判定基準**:
- CS < 0.5: 正常
- 0.5 ≤ CS < 0.75: 要注意
- CS ≥ 0.75: 特に注意

## UI/UX設計方針

### 画面構成（案）

```
┌─────────────────────────────────────────┐
│ ヘッダー: SPChart - S-P表分析ツール     │
├─────────────────────────────────────────┤
│ [CSVファイル選択] [サンプルデータ]      │
├─────────────────────────────────────────┤
│                                         │
│          S-P表 可視化エリア             │
│    （行列 + S曲線(青) + P曲線(赤)）     │
│                                         │
├─────────────────────────────────────────┤
│ 統計サマリー:                           │
│ - 差異係数: 0.XX                        │
│ - 要注意生徒: X名                       │
│ - 要注意問題: X問                       │
├─────────────────────────────────────────┤
│ [生徒一覧タブ] [問題一覧タブ]           │
│ ・注意係数付きリスト                    │
│ ・0.5以上はハイライト                   │
├─────────────────────────────────────────┤
│ [PDF出力] [画像出力]                    │
└─────────────────────────────────────────┘
```

### UX原則

1. **認知負荷の最小化**: 必要な情報のみ表示
2. **段階的開示**: 詳細は必要時のみ展開
3. **即時フィードバック**: ファイル読込後0.4秒以内に結果表示
4. **視覚的階層**: 重要度に応じた色・サイズの使い分け

## 設計レビューチェックリスト

Claude Codeの実装をレビューする際の観点：

- [ ] データ構造は仕様通りか
- [ ] 注意係数の計算は正確か
- [ ] ゼロ除算の例外処理があるか
- [ ] エッジケース（空データ、1人/1問）の処理
- [ ] パフォーマンス（1000人規模でも動作するか）
- [ ] アクセシビリティ（色覚多様性への配慮）

## 開発フェーズ

### Phase 0: 環境構築（現在）
- プロジェクト初期設定
- 三者間協働体制の確立

### Phase 1: コア機能
- CSVデータ読込
- 並べ替え処理
- S曲線・P曲線の描画

### Phase 2: 統計機能
- 注意係数（CS/CP）の計算
- 差異係数の計算
- 要注意フラグの表示

### Phase 3: 出力機能
- PDF/画像エクスポート
- 印刷対応レイアウト

### Phase 4: 拡張機能
- 文部科学省形式との互換性
- PWA対応
- 多言語対応（英語）

## ログ・決定事項の管理

- **日次ログ**: `LOG/YYYY-MM-DD.md`
- **確定事項**: `DECISIONS.md` に1行形式で記録
- **設計ドキュメント**: `docs/engineering/` に格納

## 参考資料

- `docs/research/sp_theory.md` - S-P表理論の詳細
- PoPuPプロジェクトの `docs/` - 類似プロジェクトの参考
